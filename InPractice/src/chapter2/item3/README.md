## 加锁机制 ##

要保持状态的一致性，就需要在单个原子操作中更新所有相关的状态变量。

### 内置锁

Java 提供了一种内置的锁机制来支持原子性：同步代码块。同步代码块包括两部分：一个是作为锁的对象，一个是作为锁保护的代码块。

关键字 synchronized 修饰的方法是一种横跨整个方法体的同步代码块，其中锁是方法调用所在的对象实例，静态的方法以 Class 对象作为锁。

每个 Java 对象都可以用做一个实现同步的锁，这些锁被称为内置锁或监视器锁。线程在进入同步代码块之前会自动获得锁，并且在退出同步代码块时自动释放锁（不论是正常退出还是异常退出）。获得内置锁的唯一途径就是进入由这个锁保护的同步代码块或方法。

Java 的内置锁相当于一种互斥锁，意味着最多只有一个线程能持有这种锁。因此，由这个锁保护的同步代码块会以原子方式执行，多个线程在执行该代码块时也不会相互干扰。并发环境中的原子性与事务（Transaction）中的原子性有相同的语义——一组语句作为一个不可分割的单元被执行。

### 重入

当某个线程请求一个由其他线程持有的锁时，发出请求的线程就会阻塞。然而由于内置锁是可重入的，因此如果某个线程试图获得一个已经由它自己持有的锁，那么请求会成功。“重入”意味着获取锁操作的粒度是“线程”，而不是“调用”。