## 对性能的思考 ##

提升性能意味着用更少的资源做更多的事情。资源的含义很广，例如 CPU 时钟周期、内存、网络带宽、I/O带宽、数据库请求、磁盘空间等。当操作性能由于某种特定的资源而受限制时，通常将该操作称为资源密集型的操作，例如 CPU 密集型。

使用多线程总会引入一些额外的性能开销，造成这些开销的操作包括：线程之间的协调（例如加锁、触发信号以及内存同步等），增加的上下文切换，线程的创建和销毁，以及线程的调度等。如果过度地使用线程，那么这些开销甚至会超过所带来的性能提升。

要想通过并发来获得更好的性能，需要努力做好两件事：更有效地利用现有处理资源，以及在出现新的处理资源时使程序尽可能地利用这些新资源。从性能监视的视角来看，CPU 需要尽可能保持保持忙碌。如果程序是计算密集型的，那么可以通过增加处理器来提升性能。

### 性能与可伸缩性

应用程序的而性能可以采用多个指标来衡量，例如服务时间、延迟时间、吞吐率、效率、可伸缩性以及容量等。其中一些指标（服务时间、等待时间）用于衡量程序的运行速度，即某个指定的任务单元需要“多快”才能处理完成。另一些指标（生产量、吞吐量）用于衡量程序的“处理能力”，即在计算资源一定的情况下，能完成“多少”工作。

可伸缩性指的是：当增加计算资源（例如 CPU、内存、存储容量或 I/O 带宽）时，程序的吞吐量或者处理能力能相应地增加。

在并发应用程序中针对可伸缩性进行设计和调整时所采用的方法与传统的性能调优方法截然不同。当进行性能调优时，其目的通常是用更小的代价完成相同的工作，例如通过缓存来重用之前计算的结果。在进行可伸缩性调优时，其目的是设法将问题的计算并行化，从而能利用更多的计算资源来完成更多的工作。

性能的这俩个方面——“多快”和“多少”，是完全独立的，有时候甚至是相互矛盾的。要实现更高的可伸缩性或硬件利用率，通常会增加各个任务所要处理的工作量，例如把任务分解为多个流水线子任务。但是，大多数提高单线程程序性能的技术，往往都会破坏可伸缩性。对于服务器应用程序而言，“多少”这个方面——可伸缩性、吞吐量和生产量，往往比“多快”这个方面更受重视。

当单线程程序达到自身处理能力的极限时，会遇到一个严重的问题：要进一步提升它的处理能力将非常困难。因此，通常会接受每个工作单元执行更长的时间或消耗更多的计算资源，以换取应用程序在增加更多资源的情况下处理更高的负载。

### 评估各种性能权衡因素

在几乎所有的工程决策中都会涉及某些形式的制衡，想要使得优化措施成熟，首先要有明确的需求。

很多开发人员对于哪些地方存在性能问题，哪种方法的运行速度更快，以及哪种方法的可伸缩性更高，往往会存在错误的直觉。因此，在对性能调优时，一定要有明确的性能需求，此外还需要一个测试程序以及真实的配置和负载等环境。在对性能调优后，需要再次测量以验证是否达到了预期的性能提升目标。